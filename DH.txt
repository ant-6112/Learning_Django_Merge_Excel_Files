# progress/views.py
import time
from django.http import JsonResponse
from django.shortcuts import render
from django.views.decorators.csrf import csrf_exempt
from .forms import UploadForm

def index(request):
    form = UploadForm()
    return render(request, 'progress/index.html', {'form': form})

@csrf_exempt
def upload_file(request):
    if request.method == 'POST':
        form = UploadForm(request.POST, request.FILES)
        if form.is_valid():
            # Simulate a long-running task
            for i in range(101):
                time.sleep(0.1)  # Simulating work being done
                # Update progress
                request.session['progress'] = i
            return JsonResponse({'status': 'completed'})
    return JsonResponse({'status': 'failed'}, status=400)

@csrf_exempt
def progress(request):
    progress = request.session.get('progress', 0)
    return JsonResponse({'progress': progress})

# progress/urls.py
from django.urls import path
from .views import index, upload_file, progress

urlpatterns = [
    path('', index, name='index'),
    path('upload/', upload_file, name='upload_file'),
    path('progress/', progress, name='progress'),
]

# progressbar_project/urls.py
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('progress.urls')),
]

<!-- progress/templates/progress/index.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Progress Bar Example</title>
    <script src="https://unpkg.com/htmx.org@1.5.0"></script>
</head>
<body>
    <h1>File Upload with Progress Bar</h1>
    <form id="upload-form" method="post" enctype="multipart/form-data" hx-post="{% url 'upload_file' %}" hx-trigger="submit">
        {% csrf_token %}
        {{ form }}
        <button type="submit">Upload</button>
    </form>
    <div id="progress-container" style="display:none;">
        <div id="progress-bar" style="width: 0%; background-color: green; height: 20px;"></div>
    </div>
    <script>
        document.querySelector('#upload-form').addEventListener('htmx:beforeRequest', function() {
            document.querySelector('#progress-container').style.display = 'block';
            updateProgress();
        });

        function updateProgress() {
            fetch("{% url 'progress' %}")
                .then(response => response.json())
                .then(data => {
                    let progressBar = document.querySelector('#progress-bar');
                    progressBar.style.width = data.progress + '%';
                    if (data.progress < 100) {
                        setTimeout(updateProgress, 100);
                    } else {
                        alert('Upload complete!');
                    }
                });
        }
    </script>
</body>
</html>



